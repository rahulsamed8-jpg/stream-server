<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İzleyici Paneli</title>
    <!-- Gerekli olan Socket.IO ve Tailwind CSS kütüphanelerini yüklüyoruz -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        video {
            transform: scaleX(-1); /* Görüntüyü aynala (isteğe bağlı) */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">

    <div class="w-full max-w-4xl p-6 bg-gray-800 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center mb-4 text-indigo-400">İzleyici Kontrol Paneli</h1>
        
        <!-- Durum Mesajı -->
        <div id="status" class="text-center text-yellow-400 mb-4 p-3 bg-gray-700 rounded-md">
            Sunucuya bağlanılıyor...
        </div>

        <!-- Başlat Butonu -->
        <div class="text-center mb-4">
            <button id="startButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-300 shadow-lg" disabled>
                Yayını Başlat
            </button>
        </div>

        <!-- Video Alanı -->
        <div class="bg-black rounded-lg overflow-hidden shadow-inner">
            <video id="remoteVideo" autoplay playsinline class="w-full h-auto"></video>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------------------
        // SUNUCU BAĞLANTISI VE AYARLAR
        // ---------------------------------------------------------------------

        // !!! ÇOK ÖNEMLİ !!!
        // Bu IP adresini, sunucunuzun (server.py) çalıştığı IP adresi ile değiştirin.
        // Şu anda yerel test için PC'nizin IP'sini (192.168.1.101) kullanıyoruz.
        // Daha sonra bunu Google VPS'inizin PUBLIC IP adresi ile değiştireceksiniz.
        const SERVER_URL = 'http://192.168.1.101:5000'; 
        
        const statusDiv = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const remoteVideo = document.getElementById('remoteVideo');

        let socket;
        let pc; // WebRTC PeerConnection

        // WebRTC için STUN sunucu yapılandırması (Google'ınkini kullanıyoruz)
        const peerConnectionConfig = {
            'iceServers': [
                { 'urls': 'stun:stun.l.google.com:19302' }
            ]
        };

        // ---------------------------------------------------------------------
        // ANA İŞLEVİ BAŞLAT
        // ---------------------------------------------------------------------
        function initialize() {
            try {
                socket = io(SERVER_URL);
                setupSocketListeners();
            } catch (error) {
                statusDiv.textContent = `Sunucuya bağlanılamadı: ${error.message}`;
                statusDiv.classList.replace('text-yellow-400', 'text-red-500');
            }

            startButton.onclick = sendStartCommand;
        }

        // ---------------------------------------------------------------------
        // 1. SOCKET.IO DİNLEYİCİLERİ
        // ---------------------------------------------------------------------
        function setupSocketListeners() {
            socket.on('connect', () => {
                statusDiv.textContent = 'Sunucuya başarıyla bağlandı. Telefonun bağlanması bekleniyor...';
                statusDiv.classList.replace('text-yellow-400', 'text-green-500');
                // Henüz başlatamayız, telefonun bağlanmasını beklemeliyiz
                // (Gelişmiş bir sistemde sunucu bize "telefon hazır" demeli)
                // Şimdilik butonu direkt aktif edelim:
                startButton.disabled = false;
            });

            socket.on('disconnect', () => {
                statusDiv.textContent = 'Sunucuyla bağlantı kesildi.';
                statusDiv.classList.replace('text-green-500', 'text-red-500');
                startButton.disabled = true;
                stopConnection();
            });

            socket.on('yayin_bitti', () => {
                statusDiv.textContent = 'Yayıncı (telefon) bağlantıyı sonlandırdı.';
                statusDiv.classList.replace('text-green-500', 'text-yellow-400');
                stopConnection();
            });

            // 4. WEBRTC SİNYALLERİNİ ALMA
            // Telefondan gelen "offer" (teklif) veya "ice candidate" (adres)
            socket.on('signal', handleSignal);
        }

        // ---------------------------------------------------------------------
        // 2. "BAŞLAT" BUTONUNA BASILDIĞINDA
        // ---------------------------------------------------------------------
        function sendStartCommand() {
            statusDiv.textContent = "Telefona 'yayını başlat' komutu gönderiliyor...";
            startButton.disabled = true;

            // 1. Python sunucusuna komutu gönder
            socket.emit('izleyici_baslat_komutu', { message: 'Lütfen yayını başlat' });
            
            // 2. WebRTC bağlantısını oluştur ve dinlemeye başla
            // Telefonun bize 'offer' göndermesini bekleyeceğiz.
            createPeerConnection();
        }

        // ---------------------------------------------------------------------
        // 3. WEBRTC BAĞLANTISINI OLUŞTUR
        // ---------------------------------------------------------------------
        function createPeerConnection() {
            if (pc) {
                pc.close(); // Önceki bağlantı varsa kapat
            }

            pc = new RTCPeerConnection(peerConnectionConfig);

            // Telefondan ekran görüntüsü (track) geldiğinde tetiklenir
            pc.ontrack = (event) => {
                statusDiv.textContent = "Yayın alınıyor!";
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    console.log('Video akışı başarıyla eklendi.');
                }
            };

            // Yeni bir ICE adresi bulunduğunda tetiklenir
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    // Bulunan adresi 'signal' yoluyla telefona gönder
                    console.log('Bulunan ICE adresi telefona gönderiliyor:', event.candidate);
                    socket.emit('signal', { type: 'ice', candidate: event.candidate });
                }
            };

            pc.oniceconnectionstatechange = () => {
                console.log('ICE Durumu:', pc.iceConnectionState);
                if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
                    statusDiv.textContent = "Bağlantı koptu veya kurulamadı.";
                    stopConnection();
                }
            };
        }
        
        // ---------------------------------------------------------------------
        // 4. TELEFONDAN GELEN SİNYALLERİ İŞLE
        // ---------------------------------------------------------------------
        async function handleSignal(data) {
            if (!pc) {
                // Eğer 'başlat' demeden sinyal gelirse (ki gelmemeli)
                createPeerConnection();
            }

            try {
                if (data.type === 'offer') {
                    // Bu, telefondan gelen "yayın teklifi"
                    console.log('Telefondan yayın teklifi (offer) alındı.');
                    await pc.setRemoteDescription(new RTCSessionDescription(data));

                    // Teklifi kabul eden bir "cevap" (answer) oluştur
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    // Cevabı 'signal' yoluyla telefona geri gönder
                    console.log('Cevap (answer) oluşturuldu ve telefona gönderiliyor.');
                    socket.emit('signal', { type: 'answer', sdp: answer.sdp });
                    statusDiv.textContent = "Teklif alındı, cevap gönderildi. Bağlantı kuruluyor...";
                
                } else if (data.type === 'ice' && data.candidate) {
                    // Bu, telefonun "adres bilgisi"
                    console.log('Telefondan ICE adresi alındı, ekleniyor.');
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                
                } else {
                    console.warn('Bilinmeyen sinyal türü alındı:', data);
                }
            } catch (error) {
                console.error('Sinyal işlenirken hata oluştu:', error);
                statusDiv.textContent = `Hata: ${error.message}`;
            }
        }

        // ---------------------------------------------------------------------
        // 5. BAĞLANTIYI TEMİZLE
        // ---------------------------------------------------------------------
        function stopConnection() {
            if (pc) {
                pc.close();
                pc = null;
            }
            remoteVideo.srcObject = null;
            startButton.disabled = false;
        }

        // Sayfa yüklendiğinde başlat
        window.onload = initialize;

    </script>
</body>
</html>
