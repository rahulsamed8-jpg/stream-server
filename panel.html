<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İzleyici Kontrol Paneli</title>
    <!-- Socket.IO kütüphanesini CDN üzerinden çekiyoruz -->
    <!-- Bu, sunucuyla gerçek zamanlı iletişim kurmamızı sağlar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        /* Arayüzü modern ve karanlık bir temada tasarlıyoruz */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.6;
        }
        #controls {
            width: 90%;
            max-width: 800px;
            padding: 24px;
            background-color: #1e1e1e;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        h1 {
            text-align: center;
            color: #ffffff;
            margin-top: 0;
            border-bottom: 2px solid #333;
            padding-bottom: 16px;
        }
        #status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        /* Bağlantı durumuna göre renkleri güncelleyeceğiz */
        .connecting { background-color: #4a4a4a; }
        .connected { background-color: #28a745; color: #ffffff; }
        .disconnected { background-color: #dc3545; color: #ffffff; }
        
        button {
            display: block;
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
            background: linear-gradient(145deg, #6a11cb, #2575fc);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        button:hover {
            opacity: 0.9;
            box-shadow: 0 6px 20px rgba(90, 116, 255, 0.5);
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* Gelen video akışının gösterileceği yer */
        #video-container {
            margin-top: 20px;
            background-color: #000000;
            border-radius: 8px;
            overflow: hidden;
            /* Görüntünün ekrana sığmasını sağlıyoruz */
            width: 100%;
            position: relative;
        }
        #remoteVideo {
            width: 100%;
            height: auto;
            display: block;
        }
    </style>
</head>
<body>

    <div id="controls">
        <h1>İzleyici Kontrol Paneli</h1>
        
        <!-- Bağlantı durumunu gösteren kutu -->
        <div id="status" class="connecting">Sunucuya bağlanılıyor...</div>
        
        <!-- Yayını başlatma butonu -->
        <button id="startButton" disabled>Yayını Başlat</button>
        
        <!-- Telefonun ekran görüntüsünün geleceği yer -->
        <div id="video-container">
            <video id="remoteVideo" playsinline autoplay muted></video>
        </div>
    </div>

    <script>
        // -----------------------------------------------------------------------------
        // SUNUCU BAĞLANTISI VE AYARLAR
        // -----------------------------------------------------------------------------

        // !!! ÇOK ÖNEMLİ !!!
        // Burası, Render.com'un bize verdiği genel (public) adres olmalıdır.
        // Bu adres, server.py dosyasının çalıştığı sunucunun adresidir.
        // Yerel test adresi (192.168...) artık burada kullanılmayacak.
        const SERVER_URL = 'https://stream-server-vr6z.onrender.com';

        const statusDiv = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const remoteVideo = document.getElementById('remoteVideo');

        let socket;
        let pc; // PeerConnection (WebRTC bağlantısı)

        // WebRTC için STUN sunucu yapılandırması (Google'ın ücretsiz sunucusunu kullanıyoruz)
        // Bu, iki cihazın (tablet ve telefon) birbirlerinin IP adreslerini bulmasını sağlar.
        const peerConnectionConfig = {
            'iceServers': [
                { 'urls': 'stun:stun.l.google.com:19302' }
            ]
        };

        // -----------------------------------------------------------------------------
        // ANA İŞLEV: SUNUCUYA BAĞLANMA
        // -----------------------------------------------------------------------------

        function connectToSignalingServer() {
            try {
                // Sunucuya (server.py) Socket.IO ile bağlanmayı deniyoruz.
                socket = io(SERVER_URL, {
                    transports: ['websocket', 'polling'] // Önce WebSocket'i dene, olmazsa polling'e geç
                });

                // 1. BAĞLANTI BAŞARILI OLDUĞUNDA
                socket.on('connect', () => {
                    console.log('Sunucuya (server.py) başarıyla bağlandı.');
                    statusDiv.textContent = 'Sunucuya başarıyla bağlandı...';
                    statusDiv.className = 'connected';
                    startButton.disabled = false; // "Başlat" butonunu aktif et
                });

                // 2. BAĞLANTI KESİLDİĞİNDE
                socket.on('disconnect', () => {
                    console.log('Sunucuyla bağlantı kesildi.');
                    statusDiv.textContent = 'Bağlantı kesildi. Yeniden bağlanılıyor...';
                    statusDiv.className = 'disconnected';
                    startButton.disabled = true;
                    // Eğer yayın sırasında bağlantı koptuysa, videoyu durdur
                    if (pc) {
                        pc.close();
                        pc = null;
                    }
                    remoteVideo.srcObject = null;
                });

                // 3. SUNUCUDAN BİR SİNYAL MESAJI GELDİĞİNDE (WebRTC için)
                socket.on('signal', handleSignalingData);
                
                // 4. TELEFON (YAYINCI) YAYINI BİTİRDİĞİNDE
                socket.on('yayin_bitti', () => {
                    console.log('Yayıncı yayını bitirdi.');
                    statusDiv.textContent = 'Yayıncı bağlantıyı sonlandırdı.';
                    if (pc) {
                        pc.close();
                        pc = null;
                    }
                    remoteVideo.srcObject = null;
                });

            } catch (err) {
                console.error('Socket.IO bağlantı hatası:', err);
                statusDiv.textContent = 'Sunucuya bağlanılamadı. (Hata)';
                statusDiv.className = 'disconnected';
            }
        }

        // -----------------------------------------------------------------------------
        // WebRTC (VİDEO AKIŞI) FONKSİYONLARI
        // -----------------------------------------------------------------------------

        // "Yayını Başlat" butonuna tıklandığında...
        startButton.onclick = () => {
            if (!socket || !socket.connected) {
                alert('Sunucuya bağlı değiliz!');
                return;
            }
            
            console.log('Yayını başlatma komutu gönderiliyor...');
            // 1. WebRTC bağlantısını hazırla
            startWebRTC();
            
            // 2. Sunucuya (server.py) "başlat" komutumuzu iletiyoruz.
            // Sunucu bu komutu alıp telefona gönderecek.
            socket.emit('izleyici_baslat_komutu', { 'message': 'Lütfen yayını başlat' });
            
            statusDiv.textContent = 'Telefondan yayın bekleniyor...';
            startButton.disabled = true;
        };

        // WebRTC bağlantısını kuran ana fonksiyon
        function startWebRTC() {
            // Eğer zaten bir bağlantı varsa, önce onu kapat
            if (pc) {
                pc.close();
            }

            pc = new RTCPeerConnection(peerConnectionConfig);
            
            // ÖNEMLİ: Bu fonksiyon, telefondan video/ses akışı geldiğinde tetiklenir
            pc.ontrack = (event) => {
                console.log('Telefondan video/ses akışı alındı!');
                statusDiv.textContent = 'Yayın Alınıyor!';
                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };
            
            // WebRTC'nin ağ adreslerini (ICE candidates) bulduğunda tetiklenir
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('ICE adresi bulundu, sunucuya gönderiliyor...');
                    // Bulunan adresi sunucuya gönder (sunucu da telefona iletecek)
                    socket.emit('signal', { 'candidate': event.candidate });
                }
            };

            // Bağlantı durumunu izle
            pc.onconnectionstatechange = (event) => {
                console.log('WebRTC Bağlantı Durumu:', pc.connectionState);
                if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed' || pc.connectionState === 'closed') {
                    statusDiv.textContent = 'Yayın bağlantısı koptu.';
                    startButton.disabled = false;
                    remoteVideo.srcObject = null;
                }
            };
        }

        // Sunucudan (veya telefondan) gelen sinyal mesajlarını (offer, answer, candidate) işler
        async function handleSignalingData(data) {
            if (!pc) {
                // Eğer biz "Başlat" demeden önce telefondan bir sinyal gelirse
                // (bu nadir bir durumdur ama olabilir), biz de bağlantıyı başlatalım.
                startWebRTC();
            }

            try {
                if (data.offer) {
                    // 1. Telefondan "yayın teklifi" (offer) geldi.
                    console.log('Telefondan "offer" alındı.');
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    
                    // 2. Biz de ona "cevap" (answer) oluşturalım.
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    
                    // 3. "Cevabımızı" sunucu üzerinden telefona gönderelim.
                    console.log('"Answer" oluşturuldu ve telefona gönderiliyor.');
                    socket.emit('signal', { 'answer': answer });
                
                } else if (data.answer) {
                    // Bu senaryo (izleyici olduğumuz için) pek olası değil, ama...
                    console.log('Telefondan "answer" alındı.');
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                
                } else if (data.candidate) {
                    // 3. Telefondan bir "ağ adresi" (ICE candidate) geldi.
                    console.log('Telefondan "ICE candidate" alındı.');
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } catch (err) {
                console.error('Sinyal işleme hatası:', err);
            }
        }

        // Sayfa yüklendiğinde sunucuya bağlanmayı başlat
        connectToSignalingServer();

    </script>
</body>
</html>

